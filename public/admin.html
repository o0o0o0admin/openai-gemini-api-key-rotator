<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Key Rotator - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
          --background: #fafafa;
          --foreground: #0a0a0a;
          --card: #ffffff;
          --card-foreground: #0a0a0a;
          --popover: #ffffff;
          --popover-foreground: #0a0a0a;
          --primary: #18181b;
          --primary-foreground: #fafafa;
          --secondary: #f4f4f5;
          --secondary-foreground: #0a0a0a;
          --muted: #f4f4f5;
          --muted-foreground: #71717a;
          --accent: #f4f4f5;
          --accent-foreground: #0a0a0a;
          --destructive: #ff2626;
          --destructive-foreground: #ffffff;
          --border: #e4e4e7;
          --input: #ffffff;
          --ring: #18181b;
          --success: #22c55e;
          --success-foreground: #ffffff;
          --warning: #f59e0b;
          --warning-foreground: #ffffff;
          --info: #3b82f6;
          --info-foreground: #ffffff;
          --radius: 0.5rem;
          --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
          --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
          --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
          --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        .dark {
          --background: #0a0a0a;
          --foreground: #fafafa;
          --card: #18181b;
          --card-foreground: #fafafa;
          --popover: #18181b;
          --popover-foreground: #fafafa;
          --primary: #fafafa;
          --primary-foreground: #18181b;
          --secondary: #27272a;
          --secondary-foreground: #fafafa;
          --muted: #27272a;
          --muted-foreground: #a1a1aa;
          --accent: #27272a;
          --accent-foreground: #fafafa;
          --destructive: #ff2626;
          --destructive-foreground: #ffffff;
          --border: #27272a;
          --input: #18181b;
          --ring: #d4d4d8;
          --success: #22c55e;
          --success-foreground: #ffffff;
          --warning: #f59e0b;
          --warning-foreground: #ffffff;
          --info: #3b82f6;
          --info-foreground: #ffffff;
          --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
          --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.3), 0 2px 4px -2px rgb(0 0 0 / 0.3);
          --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
          --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.3), 0 8px 10px -6px rgb(0 0 0 / 0.3);
        }
        
        * {
            box-sizing: border-box;
        }
        
        body {
            background-color: var(--background);
            color: var(--foreground);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.5;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .section {
            background-color: var(--card);
            color: var(--foreground);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .section-header {
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .input-group {
            background-color: var(--muted);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .key-row {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .login-container {
            background-color: var(--card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
        }
        
        .btn {
            border: none;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: var(--primary-foreground);
        }
        
        .btn-primary:hover {
            opacity: 0.9;
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: var(--secondary-foreground);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background-color: var(--accent);
        }
        
        .btn-destructive {
            background-color: var(--destructive);
            color: var(--destructive-foreground);
        }
        
        .btn-destructive:hover {
            opacity: 0.9;
        }
        
        .btn-success {
            background-color: var(--success);
            color: var(--success-foreground);
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: var(--warning-foreground);
        }
        
        .btn-info {
            background-color: var(--info);
            color: var(--info-foreground);
        }
        
        .input-field {
            background-color: var(--input);
            border: 1px solid var(--border);
            color: var(--foreground);
            border-radius: var(--radius);
            font-family: inherit;
        }
        
        .input-field:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .muted {
            color: var(--muted-foreground);
        }
        
        /* Header styles */
        .header-bg {
            background-color: var(--card);
            border-bottom: 1px solid var(--border);
        }
        
        /* Tab styles */
        .tab-btn {
            position: relative;
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 2px;
            background-color: var(--primary);
            border-radius: 2px;
        }
        
        /* Dark mode toggle */
        .theme-toggle {
            position: relative;
            width: 50px;
            height: 24px;
            background-color: var(--muted);
            border-radius: 12px;
            cursor: pointer;
            border: 2px solid var(--border);
        }
        
        .theme-toggle::before {
            content: '';
            position: absolute;
            top: 1px;
            left: 1px;
            width: 16px;
            height: 16px;
            background-color: var(--foreground);
            border-radius: 50%;
            transition: transform 0.2s ease;
            border: 2px solid var(--background);
        }
        
        .theme-toggle.dark::before {
            transform: translateX(22px);
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        background: 'var(--background)',
                        foreground: 'var(--foreground)',
                        card: 'var(--card)',
                        'card-foreground': 'var(--card-foreground)',
                        primary: 'var(--primary)',
                        'primary-foreground': 'var(--primary-foreground)',
                        secondary: 'var(--secondary)',
                        'secondary-foreground': 'var(--secondary-foreground)',
                        muted: 'var(--muted)',
                        'muted-foreground': 'var(--muted-foreground)',
                        destructive: 'var(--destructive)',
                        'destructive-foreground': 'var(--destructive-foreground)',
                        border: 'var(--border)',
                        input: 'var(--input)',
                        ring: 'var(--ring)',
                    },
                    fontFamily: {
                        sans: 'var(--font-sans)',
                        mono: 'var(--font-mono)',
                    },
                    borderRadius: {
                        lg: 'var(--radius)',
                        md: 'calc(var(--radius) - 2px)',
                        sm: 'calc(var(--radius) - 4px)',
                    },
                    boxShadow: {
                        sm: 'var(--shadow-sm)',
                        md: 'var(--shadow-md)',
                        lg: 'var(--shadow-lg)',
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-background" id="mainBody">
    <!-- Login Form -->
    <div id="loginForm" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md space-y-8">
            <div class="text-center">
                <div class="mx-auto h-12 w-12 flex items-center justify-center bg-primary text-primary-foreground rounded-lg mb-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                </div>
                <h1 class="text-2xl font-bold text-foreground">Admin Login</h1>
                <p class="text-muted-foreground mt-2">Enter your admin password to access the panel</p>
            </div>
            
            <div class="login-container p-6">
                <div class="space-y-4">
                    <div>
                        <label for="password" class="block text-sm font-medium text-foreground mb-2">Password</label>
                        <input 
                            type="password" 
                            id="password" 
                            class="input-field w-full px-3 py-2 rounded-md transition-colors" 
                            placeholder="Enter admin password"
                        >
                    </div>
                    <button 
                        onclick="login()" 
                        class="btn btn-primary w-full py-3 px-4 font-medium"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                        </svg>
                        Sign In
                    </button>
                    <div id="loginError" class="hidden bg-destructive/10 border border-destructive/20 text-destructive px-3 py-2 rounded-md text-sm"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden min-h-screen">
        <!-- Header -->
        <header class="header-bg">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-3">
                    <div class="flex items-center space-x-3">
                        <div class="h-7 w-7 bg-primary text-primary-foreground rounded-lg flex items-center justify-center">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                        </div>
                        <div>
                            <h1 class="text-lg font-semibold text-foreground">API Key Rotator</h1>
                            <p class="text-xs text-muted-foreground">Admin Dashboard</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <!-- Dark Mode Toggle -->
                        <div class="flex items-center space-x-1.5">
                            <svg class="w-3 h-3 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                            </svg>
                            <div class="theme-toggle" id="themeToggle" onclick="toggleTheme()"></div>
                            <svg class="w-3 h-3 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                            </svg>
                        </div>
                        <button 
                            onclick="logout()" 
                            class="btn btn-destructive px-3 py-1.5 text-xs font-medium"
                        >
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                            </svg>
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="header-bg border-b border-border">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <nav class="flex space-x-6">
                    <button 
                        onclick="showTab('environment')" 
                        class="tab-btn py-3 px-2 border-b-2 border-transparent text-muted-foreground hover:text-foreground hover:border-border transition-colors active flex items-center space-x-2"
                        data-tab="environment"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                        </svg>
                        <span class="text-sm">API Keys</span>
                    </button>
                    <button 
                        onclick="showTab('logs')" 
                        class="tab-btn py-3 px-2 border-b-2 border-transparent text-muted-foreground hover:text-foreground hover:border-border transition-colors flex items-center space-x-2"
                        data-tab="logs"
                    >
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                        </svg>
                        <span class="text-sm">API Logs</span>
                    </button>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <!-- Environment Tab -->
            <div id="environment" class="tab-content">
                <div class="section-header">
                    <h2 class="text-lg font-semibold text-foreground">API Keys Management</h2>
                    <p class="text-muted-foreground text-xs mt-1">Manage and test your API keys</p>
                </div>

                <!-- Basic Configuration -->
                <div class="section">
                    <h3 class="text-sm font-medium text-foreground mb-3">Basic Configuration</h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-muted-foreground mb-2">Base URL (Optional)</label>
                            <div class="flex items-center space-x-2">
                                <input 
                                    type="text" 
                                    id="env_BASE_URL" 
                                    class="input-field flex-1 px-2 py-1.5 text-sm rounded transition-colors" 
                                    placeholder="https://api.example.com"
                                    oninput="handleInputChange('baseUrl', this.value)"
                                >
                                <button 
                                    id="saveBaseUrlBtn"
                                    onclick="saveBaseUrl()" 
                                    class="btn btn-primary px-2 py-1.5 text-xs font-medium opacity-50 cursor-not-allowed"
                                    disabled
                                >
                                    <span>Save</span>
                                </button>
                                <button 
                                    onclick="showDeleteBaseUrlConfirm()" 
                                    class="text-destructive hover:text-destructive/80 transition-colors p-1.5"
                                    title="Delete Base URL"
                                >
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                            <p class="text-muted-foreground text-xs mt-1">Override the default API endpoints for both OpenAI and Gemini</p>
                            <div id="baseUrlResult"></div>
                        </div>
                    </div>
                </div>

                <!-- API Keys List -->
                <div class="space-y-4">
                    <!-- OpenAI API Keys -->
                    <div class="section">
                        <h3 class="text-sm font-medium text-foreground mb-3">OpenAI API Keys</h3>
                        <div id="openaiKeysContainer" class="space-y-2 mb-3"></div>
                        <!-- Add new OpenAI key input -->
                        <div class="border-dashed border border-border rounded p-3 bg-muted/30">
                            <div class="flex items-center space-x-2">
                                <input 
                                    type="text" 
                                    id="newOpenaiKey" 
                                    class="input-field flex-1 px-2 py-1.5 text-sm rounded transition-colors" 
                                    placeholder="sk-..."
                                    onkeypress="handleAddKeyEnter(event, 'openai')"
                                >
                                <button 
                                    onclick="testNewApiKey('openai')" 
                                    class="btn btn-secondary px-2 py-1.5 text-xs font-medium"
                                >
                                    <span>Test</span>
                                </button>
                                <button 
                                    onclick="addApiKey('openai')" 
                                    class="btn btn-primary px-2 py-1.5 text-xs font-medium"
                                >
                                    <span>Add</span>
                                </button>
                            </div>
                            <div id="newOpenaiKeyResult" class="mt-2"></div>
                        </div>
                    </div>

                    <!-- Gemini API Keys -->
                    <div class="section">
                        <h3 class="text-sm font-medium text-foreground mb-3">Gemini API Keys</h3>
                        <div id="geminiKeysContainer" class="space-y-2 mb-3"></div>
                        <!-- Add new Gemini key input -->
                        <div class="border-dashed border border-border rounded p-3 bg-muted/30">
                            <div class="flex items-center space-x-2">
                                <input 
                                    type="text" 
                                    id="newGeminiKey" 
                                    class="input-field flex-1 px-2 py-1.5 text-sm rounded transition-colors" 
                                    placeholder="AIzaSy..."
                                    onkeypress="handleAddKeyEnter(event, 'gemini')"
                                >
                                <button 
                                    onclick="testNewApiKey('gemini')" 
                                    class="btn btn-secondary px-2 py-1.5 text-xs font-medium"
                                >
                                    <span>Test</span>
                                </button>
                                <button 
                                    onclick="addApiKey('gemini')" 
                                    class="btn btn-primary px-2 py-1.5 text-xs font-medium"
                                >
                                    <span>Add</span>
                                </button>
                            </div>
                            <div id="newGeminiKeyResult" class="mt-2"></div>
                        </div>
                    </div>
                </div>

                <!-- Status Messages -->
                <div id="envSuccess" class="hidden bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-md mt-4"></div>
                <div id="envError" class="hidden bg-destructive/10 border border-destructive/20 text-destructive px-4 py-3 rounded-md mt-4"></div>
            </div>

            <!-- Logs Tab -->
            <div id="logs" class="tab-content hidden">
                <div class="section-header">
                    <h2 class="text-lg font-semibold text-foreground">API Request Logs</h2>
                    <p class="text-muted-foreground text-xs mt-1">Monitor OpenAI and Gemini API requests and responses</p>
                </div>

                <div class="space-y-4">
                    <!-- File Logging Settings -->
                    <div class="section">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-medium text-foreground">File Logging</h3>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="loggingToggle" class="sr-only peer" onchange="toggleLogging()">
                                <div class="w-9 h-5 bg-red-400 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-500"></div>
                            </label>
                        </div>
                        <p class="text-muted-foreground text-xs">
                            Enable file logging to save all LLM API requests to a log file. Only OpenAI and Gemini API calls are logged. Logs are also kept in memory (last 1000 entries).
                        </p>
                    </div>

                    <!-- Logs Display -->
                    <div class="section">
                        <h3 class="text-sm font-medium text-foreground mb-3">Recent API Requests</h3>
                        <div class="bg-gray-900 border border-border rounded">
                            <div id="logsContainer" class="text-green-400 p-3 font-mono text-xs h-80 overflow-y-auto whitespace-pre-wrap"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Confirmation Dialog -->
    <div id="confirmDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-card border border-border rounded-lg p-6 max-w-md w-full shadow-xl">
            <div class="flex items-center space-x-3 mb-4">
                <div class="h-10 w-10 bg-destructive/10 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5 text-destructive" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-lg font-semibold text-foreground">Delete API Key</h3>
                    <p class="text-sm text-muted-foreground">This action cannot be undone</p>
                </div>
            </div>
            <p class="text-foreground mb-6" id="confirmMessage">Are you sure you want to delete this API key?</p>
            <div class="flex justify-end space-x-3">
                <button 
                    onclick="cancelDelete()" 
                    class="btn btn-secondary px-4 py-2 text-sm font-medium"
                >
                    Cancel
                </button>
                <button 
                    onclick="confirmDelete()" 
                    class="btn btn-destructive px-4 py-2 text-sm font-medium"
                >
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Response Viewer Dialog -->
    <div id="responseDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-card border border-border rounded-lg p-6 max-w-4xl w-full h-[80vh] flex flex-col shadow-xl">
            <div class="flex items-center justify-between mb-4 flex-shrink-0">
                <div>
                    <h3 class="text-lg font-semibold text-foreground">API Response</h3>
                    <p class="text-sm text-muted-foreground" id="responseInfo">Loading...</p>
                </div>
                <button 
                    onclick="closeResponseDialog()" 
                    class="text-muted-foreground hover:text-foreground transition-colors p-1"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- Tabs for Request/Response -->
            <div class="flex space-x-4 mb-4 flex-shrink-0" id="requestResponseTabs">
                <button 
                    id="responseTab"
                    onclick="switchResponseTab('response')" 
                    class="px-4 py-2 rounded-md text-sm font-medium btn-primary"
                >
                    Response
                </button>
                <button 
                    id="requestTab"
                    onclick="switchResponseTab('request')" 
                    class="px-4 py-2 rounded-md text-sm font-medium btn-secondary hidden"
                >
                    Request Body
                </button>
            </div>
            
            <div class="flex-1 min-h-0">
                <pre id="responseContent" class="bg-gray-900 text-green-400 p-4 rounded-md text-sm h-full overflow-auto font-mono whitespace-pre-wrap border"></pre>
                <pre id="requestContent" class="bg-gray-900 text-yellow-400 p-4 rounded-md text-sm h-full overflow-auto font-mono whitespace-pre-wrap border hidden"></pre>
            </div>
        </div>
    </div>

    <script>
        let envVars = {};
        
        // Dark mode functionality
        function toggleTheme() {
            const body = document.getElementById('mainBody');
            const themeToggle = document.getElementById('themeToggle');
            
            if (body.classList.contains('dark')) {
                body.classList.remove('dark');
                themeToggle.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark');
                themeToggle.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }
        
        // Initialize theme from localStorage
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme');
            const body = document.getElementById('mainBody');
            const themeToggle = document.getElementById('themeToggle');
            
            // Default to dark mode if no preference is saved
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                body.classList.add('dark');
                if (themeToggle) {
                    themeToggle.classList.add('dark');
                }
            }
        }
        
        // Login functionality
        async function login() {
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            try {
                const response = await fetch('/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                if (response.ok) {
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    loadEnvVars();
                    loadLoggingStatus();
                } else {
                    errorDiv.textContent = 'Invalid password';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Login failed: ' + error.message;
                errorDiv.classList.remove('hidden');
            }
        }
        
        async function logout() {
            try {
                await fetch('/admin/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
            } catch (error) {
                console.log('Logout request failed, but continuing with local logout');
            }
            
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('password').value = '';
        }
        
        // Environment variables functionality
        async function loadEnvVars() {
            try {
                const response = await fetch('/admin/api/env');
                envVars = await response.json();
                renderEnvVars();
            } catch (error) {
                showError('envError', 'Failed to load environment variables: ' + error.message);
            }
        }
        
        let originalValues = {};
        
        function renderEnvVars() {
            // Load basic configuration
            const baseUrlInput = document.getElementById('env_BASE_URL');
            baseUrlInput.value = envVars.BASE_URL || '';
            originalValues.baseUrl = baseUrlInput.value;
            
            // Load file logging status
            document.getElementById('loggingToggle').checked = envVars.FILE_LOGGING === 'true';
            
            // Parse and display OpenAI keys
            const openaiKeys = envVars.OPENAI_API_KEYS ? envVars.OPENAI_API_KEYS.split(',') : [];
            const openaiContainer = document.getElementById('openaiKeysContainer');
            openaiContainer.innerHTML = '';
            
            openaiKeys.forEach((key, index) => {
                if (key.trim()) {
                    const keyDiv = document.createElement('div');
                    keyDiv.className = 'key-row';
                    keyDiv.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <input 
                                type="text" 
                                value="${key.trim()}" 
                                class="input-field flex-1 px-2 py-1.5 rounded transition-colors font-mono text-sm" 
                                oninput="handleApiKeyChange('openai', ${index}, this.value)"
                                data-original-value="${key.trim()}"
                            >
                            <button 
                                id="saveOpenaiBtn-${index}"
                                onclick="saveSpecificApiKey('openai', ${index})" 
                                class="btn btn-primary px-2 py-1.5 text-xs font-medium opacity-50 cursor-not-allowed"
                                disabled
                            >
                                <span>Save</span>
                            </button>
                            <button 
                                onclick="testSpecificApiKey('openai', '${key.trim()}', ${index})" 
                                class="btn btn-secondary px-2 py-1.5 text-xs font-medium"
                            >
                                <span>Test</span>
                            </button>
                            <button 
                                onclick="showDeleteConfirm('openai', ${index})" 
                                class="text-destructive hover:text-destructive/80 transition-colors p-2"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                        <div id="openai-test-result-${index}" class="mt-2"></div>
                    `;
                    openaiContainer.appendChild(keyDiv);
                }
            });
            
            // Parse and display Gemini keys
            const geminiKeys = envVars.GEMINI_API_KEYS ? envVars.GEMINI_API_KEYS.split(',') : [];
            const geminiContainer = document.getElementById('geminiKeysContainer');
            geminiContainer.innerHTML = '';
            
            geminiKeys.forEach((key, index) => {
                if (key.trim()) {
                    const keyDiv = document.createElement('div');
                    keyDiv.className = 'key-row';
                    keyDiv.innerHTML = `
                        <div class="flex items-center space-x-2">
                            <input 
                                type="text" 
                                value="${key.trim()}" 
                                class="input-field flex-1 px-2 py-1.5 rounded transition-colors font-mono text-sm" 
                                oninput="handleApiKeyChange('gemini', ${index}, this.value)"
                                data-original-value="${key.trim()}"
                            >
                            <button 
                                id="saveGeminiBtn-${index}"
                                onclick="saveSpecificApiKey('gemini', ${index})" 
                                class="btn btn-primary px-2 py-1.5 text-xs font-medium opacity-50 cursor-not-allowed"
                                disabled
                            >
                                <span>Save</span>
                            </button>
                            <button 
                                onclick="testSpecificApiKey('gemini', '${key.trim()}', ${index})" 
                                class="btn btn-secondary px-2 py-1.5 text-xs font-medium"
                            >
                                <span>Test</span>
                            </button>
                            <button 
                                onclick="showDeleteConfirm('gemini', ${index})" 
                                class="text-destructive hover:text-destructive/80 transition-colors p-2"
                            >
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                        <div id="gemini-test-result-${index}" class="mt-2"></div>
                    `;
                    geminiContainer.appendChild(keyDiv);
                }
            });
        }
        
        function updateEnvVar(key, value) {
            envVars[key] = value;
        }
        
        // Handle input changes and enable/disable save buttons
        function handleInputChange(inputType, value) {
            if (inputType === 'baseUrl') {
                envVars.BASE_URL = value;
                const saveBtn = document.getElementById('saveBaseUrlBtn');
                const hasChanged = value !== originalValues.baseUrl;
                
                if (hasChanged) {
                    saveBtn.disabled = false;
                    saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    saveBtn.classList.add('hover:opacity-90');
                } else {
                    saveBtn.disabled = true;
                    saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    saveBtn.classList.remove('hover:opacity-90');
                }
            }
        }
        
        function handleApiKeyChange(apiType, index, value) {
            updateApiKey(apiType, index, value);
            const saveBtn = document.getElementById(`save${apiType.charAt(0).toUpperCase() + apiType.slice(1)}Btn-${index}`);
            const input = event.target;
            const originalValue = input.getAttribute('data-original-value');
            const hasChanged = value !== originalValue;
            
            if (hasChanged) {
                saveBtn.disabled = false;
                saveBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                saveBtn.classList.add('hover:opacity-90');
            } else {
                saveBtn.disabled = true;
                saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
                saveBtn.classList.remove('hover:opacity-90');
            }
        }
        
        function updateApiKey(apiType, index, value) {
            const keyName = apiType === 'openai' ? 'OPENAI_API_KEYS' : 'GEMINI_API_KEYS';
            const keys = envVars[keyName] ? envVars[keyName].split(',') : [];
            keys[index] = value.trim();
            envVars[keyName] = keys.filter(k => k.trim()).join(',');
        }
        
        async function removeApiKey(apiType, index) {
            const keyName = apiType === 'openai' ? 'OPENAI_API_KEYS' : 'GEMINI_API_KEYS';
            const keys = envVars[keyName] ? envVars[keyName].split(',') : [];
            keys.splice(index, 1);
            envVars[keyName] = keys.filter(k => k.trim()).join(',');
            
            // Save the changes to .env file
            try {
                const response = await fetch('/admin/api/env', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(envVars)
                });
                
                if (response.ok) {
                    renderEnvVars();
                } else {
                    showError('envError', 'Failed to delete API key');
                }
            } catch (error) {
                showError('envError', 'Delete failed: ' + error.message);
            }
        }
        
        // Confirmation dialog variables
        let pendingDelete = null;
        
        function showDeleteConfirm(apiType, index) {
            const keyName = apiType === 'openai' ? 'OPENAI_API_KEYS' : 'GEMINI_API_KEYS';
            const keys = envVars[keyName] ? envVars[keyName].split(',') : [];
            const keyToDelete = keys[index];
            
            // Store the delete action for later
            pendingDelete = { type: 'apiKey', apiType, index };
            
            // Update the confirmation message
            const maskedKey = keyToDelete.length > 8 
                ? keyToDelete.substring(0, 8) + '...' + keyToDelete.slice(-4)
                : keyToDelete;
            document.getElementById('confirmMessage').textContent = 
                `Are you sure you want to delete this ${apiType.toUpperCase()} API key?\n\nKey: ${maskedKey}`;
            
            // Show dialog
            document.getElementById('confirmDialog').classList.remove('hidden');
        }
        
        function showDeleteBaseUrlConfirm() {
            const currentBaseUrl = document.getElementById('env_BASE_URL').value || 'Not set';
            
            // Store the delete action for later
            pendingDelete = { type: 'baseUrl' };
            
            // Update the confirmation message
            document.getElementById('confirmMessage').textContent = 
                `Are you sure you want to delete the Base URL from your configuration?\n\nCurrent value: ${currentBaseUrl}\n\nThis will remove BASE_URL from your .env file and revert to default API endpoints.`;
            
            // Show dialog
            document.getElementById('confirmDialog').classList.remove('hidden');
        }
        
        function cancelDelete() {
            pendingDelete = null;
            document.getElementById('confirmDialog').classList.add('hidden');
        }
        
        function confirmDelete() {
            if (pendingDelete) {
                if (pendingDelete.type === 'apiKey') {
                    removeApiKey(pendingDelete.apiType, pendingDelete.index);
                } else if (pendingDelete.type === 'baseUrl') {
                    deleteBaseUrl();
                }
                pendingDelete = null;
            }
            document.getElementById('confirmDialog').classList.add('hidden');
        }
        
        async function addApiKey(apiType) {
            const inputId = apiType === 'openai' ? 'newOpenaiKey' : 'newGeminiKey';
            const keyName = apiType === 'openai' ? 'OPENAI_API_KEYS' : 'GEMINI_API_KEYS';
            const resultId = apiType === 'openai' ? 'newOpenaiKeyResult' : 'newGeminiKeyResult';
            const newKey = document.getElementById(inputId).value.trim();
            const resultDiv = document.getElementById(resultId);
            
            if (newKey) {
                // Update the envVars object
                const existingKeys = envVars[keyName] ? envVars[keyName].split(',') : [];
                existingKeys.push(newKey);
                envVars[keyName] = existingKeys.filter(k => k.trim()).join(',');
                
                // Save to .env file
                try {
                    const response = await fetch('/admin/api/env', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(envVars)
                    });
                    
                    if (response.ok) {
                        document.getElementById(inputId).value = '';
                        renderEnvVars();
                        
                        // Show success message
                        resultDiv.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-800 px-3 py-2 rounded-md text-sm flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span>API key added successfully!</span></div>';
                        setTimeout(() => {
                            resultDiv.innerHTML = '';
                        }, 3000);
                    } else {
                        showError('envError', 'Failed to save API key to .env file');
                        // Revert the change
                        const revertedKeys = existingKeys.slice(0, -1);
                        envVars[keyName] = revertedKeys.filter(k => k.trim()).join(',');
                    }
                } catch (error) {
                    showError('envError', 'Failed to save API key: ' + error.message);
                    // Revert the change
                    const revertedKeys = existingKeys.slice(0, -1);
                    envVars[keyName] = revertedKeys.filter(k => k.trim()).join(',');
                }
            }
        }
        
        function handleAddKeyEnter(event, apiType) {
            if (event.key === 'Enter') {
                addApiKey(apiType);
            }
        }
        
        // Delete base URL
        async function deleteBaseUrl() {
            try {
                // Remove BASE_URL from envVars
                delete envVars.BASE_URL;
                
                const response = await fetch('/admin/api/env', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(envVars)
                });
                
                if (response.ok) {
                    // Clear the input field and reset original value
                    document.getElementById('env_BASE_URL').value = '';
                    originalValues.baseUrl = '';
                    
                    // Disable save button
                    const saveBtn = document.getElementById('saveBaseUrlBtn');
                    saveBtn.disabled = true;
                    saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    saveBtn.classList.remove('hover:opacity-90');
                    
                    const resultDiv = document.getElementById('baseUrlResult');
                    resultDiv.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-800 px-3 py-2 rounded-md text-sm mt-2 flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span>Base URL deleted from .env file!</span></div>';
                    setTimeout(() => {
                        resultDiv.innerHTML = '';
                    }, 2000);
                } else {
                    showError('envError', 'Failed to delete base URL');
                }
            } catch (error) {
                showError('envError', 'Delete failed: ' + error.message);
            }
        }
        
        // Save base URL
        async function saveBaseUrl() {
            try {
                const response = await fetch('/admin/api/env', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(envVars)
                });
                
                if (response.ok) {
                    // Update original value and disable save button
                    originalValues.baseUrl = envVars.BASE_URL;
                    const saveBtn = document.getElementById('saveBaseUrlBtn');
                    saveBtn.disabled = true;
                    saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    saveBtn.classList.remove('hover:opacity-90');
                    
                    const resultDiv = document.getElementById('baseUrlResult');
                    resultDiv.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-800 px-3 py-2 rounded-md text-sm mt-2 flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span>Base URL saved!</span></div>';
                    setTimeout(() => {
                        resultDiv.innerHTML = '';
                    }, 2000);
                } else {
                    showError('envError', 'Failed to save base URL');
                }
            } catch (error) {
                showError('envError', 'Save failed: ' + error.message);
            }
        }
        
        // Save individual API key
        async function saveSpecificApiKey(apiType, index) {
            try {
                const response = await fetch('/admin/api/env', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(envVars)
                });
                
                if (response.ok) {
                    // Update original value and disable save button
                    const keyName = apiType === 'openai' ? 'OPENAI_API_KEYS' : 'GEMINI_API_KEYS';
                    const keys = envVars[keyName] ? envVars[keyName].split(',') : [];
                    const newValue = keys[index];
                    
                    // Find the input and update its original value
                    const inputs = document.querySelectorAll(`#${apiType}KeysContainer input`);
                    if (inputs[index]) {
                        inputs[index].setAttribute('data-original-value', newValue);
                    }
                    
                    // Disable save button
                    const saveBtn = document.getElementById(`save${apiType.charAt(0).toUpperCase() + apiType.slice(1)}Btn-${index}`);
                    saveBtn.disabled = true;
                    saveBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    saveBtn.classList.remove('hover:opacity-90');
                    
                    // Show success feedback briefly
                    const resultDiv = document.getElementById(`${apiType}-test-result-${index}`);
                    resultDiv.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-800 px-3 py-2 rounded-md text-sm mt-2 flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span>Saved!</span></div>';
                    setTimeout(() => {
                        resultDiv.innerHTML = '';
                    }, 2000);
                } else {
                    showError('envError', 'Failed to save API key');
                }
            } catch (error) {
                showError('envError', 'Save failed: ' + error.message);
            }
        }
        
        // Test new API key before adding
        async function testNewApiKey(apiType) {
            const inputId = apiType === 'openai' ? 'newOpenaiKey' : 'newGeminiKey';
            const resultId = apiType === 'openai' ? 'newOpenaiKeyResult' : 'newGeminiKeyResult';
            const keyInput = document.getElementById(inputId);
            const resultDiv = document.getElementById(resultId);
            
            const apiKey = keyInput.value.trim();
            if (!apiKey) {
                resultDiv.innerHTML = '<div class="bg-destructive/10 border border-destructive/20 text-destructive px-3 py-2 rounded-md text-sm">Please enter an API key first</div>';
                setTimeout(() => {
                    resultDiv.innerHTML = '';
                }, 3000);
                return;
            }
            
            resultDiv.innerHTML = '<div class="bg-blue-50 border border-blue-200 text-blue-800 px-3 py-2 rounded-md text-sm">Testing...</div>';
            
            try {
                const response = await fetch('/admin/api/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        apiType: apiType, 
                        apiKey: apiKey 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-800 px-3 py-2 rounded-md text-sm flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>Valid! Ready to add.</span></div>';
                } else {
                    resultDiv.innerHTML = `<div class="bg-destructive/10 border border-destructive/20 text-destructive px-3 py-2 rounded-md text-sm flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg><span>Invalid key</span></div>`;
                }
                
                // Clear result after 5 seconds
                setTimeout(() => {
                    resultDiv.innerHTML = '';
                }, 5000);
            } catch (error) {
                resultDiv.innerHTML = `<div class="bg-destructive/10 border border-destructive/20 text-destructive px-3 py-2 rounded-md text-sm">Test failed</div>`;
                setTimeout(() => {
                    resultDiv.innerHTML = '';
                }, 3000);
            }
        }

        // API Testing functionality for individual keys
        async function testSpecificApiKey(apiType, apiKey, index) {
            const resultDiv = document.getElementById(`${apiType}-test-result-${index}`);
            
            resultDiv.innerHTML = '<div class="bg-blue-50 border border-blue-200 text-blue-800 px-3 py-2 rounded-md text-sm mt-2">Testing...</div>';
            
            try {
                const response = await fetch('/admin/api/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        apiType: apiType, 
                        apiKey: apiKey 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-800 px-3 py-2 rounded-md text-sm mt-2 flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>Valid!</span></div>';
                } else {
                    resultDiv.innerHTML = `<div class="bg-destructive/10 border border-destructive/20 text-destructive px-3 py-2 rounded-md text-sm mt-2 flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg><span>Invalid</span></div>`;
                }
                
                // Clear result after 3 seconds
                setTimeout(() => {
                    resultDiv.innerHTML = '';
                }, 3000);
            } catch (error) {
                resultDiv.innerHTML = `<div class="bg-destructive/10 border border-destructive/20 text-destructive px-3 py-2 rounded-md text-sm mt-2">Test failed</div>`;
                setTimeout(() => {
                    resultDiv.innerHTML = '';
                }, 3000);
            }
        }
        
        async function saveEnvVars() {
            try {
                const response = await fetch('/admin/api/env', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(envVars)
                });
                
                if (response.ok) {
                    showSuccess('envSuccess', 'Environment variables saved and configuration reloaded!');
                } else {
                    showError('envError', 'Failed to save environment variables');
                }
            } catch (error) {
                showError('envError', 'Save failed: ' + error.message);
            }
        }
        
        // API Testing functionality
        async function testApiKey(apiType) {
            const keyInput = document.getElementById(`${apiType}TestKey`);
            const resultDiv = document.getElementById(`${apiType}TestResult`);
            
            if (!keyInput.value.trim()) {
                resultDiv.innerHTML = '<div class="bg-destructive/10 border border-destructive/20 text-destructive px-3 py-2 rounded-md text-sm mt-3">Please enter an API key</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="bg-blue-50 border border-blue-200 text-blue-800 px-3 py-2 rounded-md text-sm mt-3">Testing...</div>';
            
            try {
                const response = await fetch('/admin/api/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        apiType: apiType, 
                        apiKey: keyInput.value.trim() 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = '<div class="bg-green-50 border border-green-200 text-green-800 px-3 py-2 rounded-md text-sm mt-3 flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span>API key is valid!</span></div>';
                } else {
                    resultDiv.innerHTML = `<div class="bg-destructive/10 border border-destructive/20 text-destructive px-3 py-2 rounded-md text-sm mt-3 flex items-center space-x-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg><span>${result.error}</span></div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="bg-destructive/10 border border-destructive/20 text-destructive px-3 py-2 rounded-md text-sm mt-3">Test failed: ${error.message}</div>`;
            }
        }
        
        // Logging functionality
        async function loadLoggingStatus() {
            try {
                const response = await fetch('/admin/api/logs');
                const data = await response.json();
                document.getElementById('loggingToggle').checked = data.fileLoggingEnabled;
            } catch (error) {
                console.error('Failed to load logging status:', error);
            }
        }
        
        async function toggleLogging() {
            const enabled = document.getElementById('loggingToggle').checked;
            
            try {
                // Update the environment variable
                envVars.FILE_LOGGING = enabled ? 'true' : 'false';
                
                // Send to server
                await fetch('/admin/api/logging', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                
                // Save the updated env vars
                await saveEnvVars();
            } catch (error) {
                console.error('Failed to toggle logging:', error);
                document.getElementById('loggingToggle').checked = !enabled;
            }
        }
        
        async function refreshLogs() {
            try {
                const response = await fetch('/admin/api/logs');
                const data = await response.json();
                
                const logsContainer = document.getElementById('logsContainer');
                if (!data.logs || data.logs.length === 0) {
                    logsContainer.textContent = 'No logs available';
                    return;
                }
                
                // Process logs to add view buttons for entries with stored data
                const processedLogs = data.logs.map(log => {
                    // Check if this is a TEST log entry
                    const testMatch = log.match(/\[TEST-([a-zA-Z0-9]+)\]/);
                    if (testMatch) {
                        const testId = testMatch[1];
                        return log + ` <button onclick="viewResponse('${testId}')" class="ml-2 text-blue-400 hover:text-blue-300 underline cursor-pointer text-xs">View Details</button>`;
                    }
                    
                    // Check if this is a REQ log entry
                    const reqMatch = log.match(/\[REQ-([a-zA-Z0-9]+)\]/);
                    if (reqMatch) {
                        const requestId = reqMatch[1];
                        return log + ` <button onclick="viewResponse('${requestId}')" class="ml-2 text-blue-400 hover:text-blue-300 underline cursor-pointer text-xs">View Details</button>`;
                    }
                    
                    return log;
                }).join('\n');
                
                logsContainer.innerHTML = processedLogs || 'No logs available';
                
                // Auto-scroll to bottom
                logsContainer.scrollTop = logsContainer.scrollHeight;
            } catch (error) {
                document.getElementById('logsContainer').textContent = 'Failed to load logs: ' + error.message;
            }
        }

        async function viewResponse(testId) {
            try {
                const response = await fetch(`/admin/api/response/${testId}`);
                if (!response.ok) {
                    alert('Response data not found');
                    return;
                }
                
                const data = await response.json();
                
                // Update dialog content
                document.getElementById('responseInfo').textContent = 
                    `${data.method} ${data.endpoint} (${data.apiType}) → ${data.status} ${data.statusText} | ${data.contentType}`;
                
                // Format JSON response
                let formattedResponse;
                try {
                    const jsonData = JSON.parse(data.responseData);
                    formattedResponse = JSON.stringify(jsonData, null, 2);
                } catch (e) {
                    // Not JSON, show as plain text
                    formattedResponse = data.responseData;
                }
                
                document.getElementById('responseContent').textContent = formattedResponse;
                
                // Handle request body tab
                const requestTab = document.getElementById('requestTab');
                const requestContent = document.getElementById('requestContent');
                
                if (data.requestBody && data.requestBody.trim()) {
                    // Show request tab if there's a request body
                    requestTab.classList.remove('hidden');
                    
                    // Format request body
                    let formattedRequest;
                    try {
                        const requestJson = JSON.parse(data.requestBody);
                        formattedRequest = JSON.stringify(requestJson, null, 2);
                    } catch (e) {
                        formattedRequest = data.requestBody;
                    }
                    
                    requestContent.textContent = formattedRequest;
                } else {
                    // Hide request tab if no request body
                    requestTab.classList.add('hidden');
                }
                
                // Start with response tab active
                switchResponseTab('response');
                
                // Show dialog
                document.getElementById('responseDialog').classList.remove('hidden');
            } catch (error) {
                alert('Failed to load response: ' + error.message);
            }
        }

        function switchResponseTab(tab) {
            const responseTab = document.getElementById('responseTab');
            const requestTab = document.getElementById('requestTab');
            const responseContent = document.getElementById('responseContent');
            const requestContent = document.getElementById('requestContent');
            
            if (tab === 'response') {
                // Activate response tab
                responseTab.className = 'px-4 py-2 rounded-md text-sm font-medium btn-primary';
                requestTab.className = 'px-4 py-2 rounded-md text-sm font-medium btn-secondary';
                responseContent.classList.remove('hidden');
                requestContent.classList.add('hidden');
            } else {
                // Activate request tab
                requestTab.className = 'px-4 py-2 rounded-md text-sm font-medium btn-primary';
                responseTab.className = 'px-4 py-2 rounded-md text-sm font-medium btn-secondary';
                requestContent.classList.remove('hidden');
                responseContent.classList.add('hidden');
            }
        }

        function closeResponseDialog() {
            document.getElementById('responseDialog').classList.add('hidden');
        }
        
        // Load logs when logs tab is shown
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active state from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-muted-foreground');
                btn.classList.remove('text-foreground', 'border-primary');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.remove('hidden');
            
            // Set active state on clicked tab button
            const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
            activeBtn.classList.add('active', 'text-foreground', 'border-primary');
            activeBtn.classList.remove('text-muted-foreground');
            
            // Load logs if logs tab is selected
            if (tabName === 'logs') {
                refreshLogs();
            }
        }
        
        // Utility functions
        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }
        
        function showSuccess(elementId, message) {
            const successDiv = document.getElementById(elementId);
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            setTimeout(() => successDiv.classList.add('hidden'), 5000);
        }
        
        // Event listeners
        document.getElementById('password').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
        
        // Dialog keyboard handling
        document.addEventListener('keydown', function(e) {
            if (!document.getElementById('confirmDialog').classList.contains('hidden')) {
                if (e.key === 'Escape') {
                    cancelDelete();
                } else if (e.key === 'Enter') {
                    confirmDelete();
                }
            }
        });
        
        // Check authentication on page load
        async function checkAuth() {
            try {
                const response = await fetch('/admin/api/auth');
                const data = await response.json();
                
                if (data.authenticated) {
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('adminPanel').classList.remove('hidden');
                    loadEnvVars();
                    loadLoggingStatus();
                }
            } catch (error) {
                console.log('Auth check failed, showing login form');
            }
        }
        
        // Initialize active tab styling and check auth
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize theme
            initializeTheme();
            
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) {
                activeTab.classList.add('text-foreground', 'border-primary');
                activeTab.classList.remove('text-muted-foreground');
            }
            
            // Check if user is already authenticated
            checkAuth();
        });
    </script>
</body>
</html>